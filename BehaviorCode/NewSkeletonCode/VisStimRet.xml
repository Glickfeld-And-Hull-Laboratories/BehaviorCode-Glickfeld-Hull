<?xml version="1.0"?>
<monkeyml version="1.0">
  <io_devices tag="IO Devices">
    <iodevice tag="LabJackU6" priority="" type="LabJackU6" 
              pulse_duration="juice" pulse_on="juice" 
              lever1="FIO1" lever2=""
              lever1_solenoid="FIO2"
              lever2_solenoid=""
              laser_trigger="laserTriggerFIO"
              strobed_digital_word="strobedDigitalWord"
              counter="counter"/>
    <iodevice tag="FakeMonkey" priority="" type="fake_monkey" id="" alt="" spike_rate="10"/>
    <iodevice type="serverside_conduit" tag="Server-side Event Conduit" resource_name="server_conduit"/>
  </io_devices>
  <variables tag="Variables">
    <folder tag="Behavioral Control">
      <variable tag="subjectNum" scope="global" logging="when_changed" default_value="0" type="integer" persistant="1"/>
      <variable tag="experimentXmlTrialId" scope="global" logging="when_changed" default_value="8" type="integer" persistant="1"/> <!-- n.b. it is forcibly set each trial below -->
      <variable tag="interStimulusIntervalMs" scope="global" logging="when_changed" default_value="20000" type="integer" persistant="1"/>
      <variable tag="nScansOn" scope="global" logging="when_changed" default_value="200" type="integer" persistant="1"/>
      <variable tag="nScansOff" scope="global" logging="when_changed" default_value="200" type="integer" persistant="1"/>
    </folder>
    <folder tag="Stimuli">
      <variable tag="gratingFramesOn" scope="global" logging="when_changed" default_value="200" type="integer" persistant="1"/>
      <variable tag="gratingFramesOff" scope="global" logging="when_changed" default_value="200" type="integer" persistant="1"/>
      <variable tag="frameRateHz" scope="global" logging="when_changed" default_value="2" type="integer" persistant="1"/>  
        
      <variable tag="stopAfterNTrials" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
        
      <variable tag="gratingElevationDeg" scope="global" logging="when_changed" default_value="20" type="float" persistant="1"/>
      <variable tag="gratingElevationStepDeg" scope="global" logging="when_changed" default_value="-20" type="float" persistant="1"/>
      <variable tag="gratingElevationStepN" scope="global" logging="when_changed" default_value="3" type="float" persistant="1"/>
      <variable tag="gratingAzimuthDeg" scope="global" logging="when_changed" default_value="-30" type="float" persistant="1"/>
      <variable tag="gratingAzimuthStepDeg" scope="global" logging="when_changed" default_value="30" type="float" persistant="1"/>
      <variable tag="gratingAzimuthStepN" scope="global" logging="when_changed" default_value="3" type="float" persistant="1"/>
      
      <variable tag="gratingContrast" scope="global" logging="when_changed" default_value="1" type="integer" persistant="1"/>  
      <variable tag="gratingDirectionDeg" scope="global" logging="when_changed" default_value="0" type="integer" persistant="1"/>
      <variable tag="gratingHeightDeg" scope="global" logging="when_changed" default_value="40" type="integer" persistant="1"/>
      <variable tag="gratingWidthDeg" scope="global" logging="when_changed" default_value="40" type="integer" persistant="1"/>
      <variable tag="gratingSpatialFreqCPD" scope="global" logging="when_changed" default_value="0.04" type="float" persistant="1"/>
      <variable tag="gratingSpeedDPS" scope="global" logging="when_changed" default_value="50" type="integer" persistant="1"/>
      <variable tag="gratingDurationMs" scope="global" logging="when_changed" default_value="100" type="integer" persistant="1"/>
      <variable tag="gratingStartingPhaseDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="1"/>

      <variable tag="doRand" scope="global" logging="when_changed" default_value="0" type="float" persistant="1"/>
      
    </folder>
    <folder tag="Task Status">
      <variable tag="stimulusOn" scope="global" logging="when_changed" default_value="0" type="boolean"/>
      <variable tag="trialStart" scope="global" logging="when_changed" default_value="0" type="boolean"/>
    </folder>
    <folder tag="Online Display">
      <variable tag="sync" scope="global" logging="when_changed" default_value="0" type="integer"/>
    </folder>
    <folder tag="Hardware variables">
      <variable tag="FIO1" full_name="FIO1" default_value="0" scope="GLOBAL" type="INTEGER" editable="never" logging="when_changed"/>
      <variable tag="FIO2" full_name="FIO2" default_value="0" scope="GLOBAL" type="boolean" editable="never" logging="when_changed"/>
      <variable tag="laserTriggerFIO" full_name="laserTriggerFIO" default_value="0" scope="GLOBAL" type="boolean" logging="when_changed" persistant="0"/>
      <variable tag="strobedDigitalWord" full_name="strobedDigitalWord" default_value="0" scope="GLOBAL" type="integer" logging="when_changed" persistant="0"/>
      <variable tag="juice" full_name="juice" scope="GLOBAL" logging="when_changed" default_value="0" type="integer"/>
      <variable tag="counter" scope="global" logging="when_changed" default_value="0" type="integer" persistant="1"></variable>
      <variable tag="sendLaserParams" full_name="sendLaserParams" scope="GLOBAL" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      <variable tag="sendSerialParams" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
    </folder>
    <folder tag="Internal Variables">
      <variable tag="tTempStim" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      <variable tag="tCounterOn" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      <variable tag="tCounterOff" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>

      <variable tag="tTrialsDoneSinceStart" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
      <variable tag="tTrialStartMWTimestampMs" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
      <variable tag="tThisTrialStartTimeMs" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
      <variable tag="tLastTrialStartTimeMs" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
        
      <variable tag="rrStimulusNumber" scope="local" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      <variable tag="tStimulusNumber" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      <variable tag="tGratingAzimuthDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingElevationDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      
      <variable tag="tGratingDirectionDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingContrast" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingElevationDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingAzimuthDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingHeightDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingWidthDeg" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingSpatialFreqCPD" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingSpeedDPS" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
      <variable tag="tGratingDurationMs" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      
        
      <variable tag="tNStimAccepted" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      <variable tag="frameCountN" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>

    </folder>
  </variables>
  <sounds tag="Sounds">
  </sounds>
  <stimuli tag="Stimuli">
    <stimulus type="blank_screen" tag="background" color="0.5,0.5,0.5"></stimulus>
    <stimulus type="drifting_grating" tag="target_grating"  direction="0" starting_phase="gratingStartingPhaseDeg"
              spatial_frequency="tGratingSpatialFreqCPD" 
              speed="tGratingSpeedDPS" 
              grating_type="sinusoid" mask="gaussian" std_dev="0.3" mean="0.1" 
              x_size="tGratingWidthDeg" y_size="tGratingHeightDeg" 
              x_position="tGratingAzimuthDeg" y_position="tGratingElevationDeg" 
              rotation="tGratingDirectionDeg" 
              alpha_multiplier="tGratingContrast"></stimulus>
  </stimuli>    
  <experiment tag="Experiment" full_name="">
    <protocol tag="JuiceOnHoldProtocol" full_name="" selection="sequential" nsamples="1" sampling_method="cycles" description="" interruptible="YES">

      <!-- init actions before running trials after any press of start-->
      <action type="queue_stimulus" stimulus="background"></action>
      <action type="assignment" variable="tTrialsDoneSinceStart" value="0"></action>
      <action type="assignment" tag="juice = 0" variable="juice" value="0"></action>

      <trial tag="Trial" full_name="Trial" description="" interruptible="1" selection="sequential" nsamples="1" sampling_method="cycles">
      <trial tag="New List" nsamples="90" sampling_method="samples" selection="random_without_replacement">
      <range_replicator tag="New Replicator" from="0" to="89" step="1" variable="rrStimulusNumber">
      
    <task_system tag="TS" full_name="TS" interruptable="YES" description="" interruptible="YES" _error="Task Systems must contain >=1 transition that yields to parent">
      <task_system_state tag="Inter Stimulus Interval" interruptible="YES">
          <action_marker _unmoveable="1" tag="Actions"></action_marker>
                                  
          <!-- if we have done enough trials, abort this trial - before any encodes/sync are done -->
          <action type="if" condition="stopAfterNTrials > 0 &amp;&amp; tTrialsDoneSinceStart >= stopAfterNTrials">
              <action type="report" message="** Stopping after completing $stopAfterNTrials trials"></action>
              <action type="stop_experiment"></action>  
          </action>
          <action tag="Start IO Device" type="start_device_IO" device="LabJackU6"></action>

          <action type="assignment" variable="tTrialStartMWTimestampMs" value="now()/1000"></action>  <!-- integer valued ms timestamp -->

          <action type="assignment" tag="Encode START" variable="strobedDigitalWord" value="170"></action>
          <action type="assignment" tag="Encode START" variable="strobedDigitalWord" value="170"></action>
          <action type="assignment" tag="Encode START" variable="strobedDigitalWord" value="170"></action>

          <!--Transmit the trial timestamp so strobed code sequences are unique -->
          <action type="assert" condition="tTrialStartMWTimestampMs &lt;= 2147483648" 
                  message="tTrialStartMWTimestampMs is too large - should happen only after several days of running!?"
                  stop_on_failure="1"/>  
          <!-- prevent overflow outside 2**31ms ~ 10 days - I don't know how to get unsigned casts in the XML -->
          <!-- encode trialStartTimestamp in bytes: 4 bytes: millions of seconds, 1000s, s, ms -->
          <action type="assignment" tag="Encode TimestampStart" variable="strobedDigitalWord" value="200"/>
          <action type="assignment" variable="strobedDigitalWord" value="tTrialStartMWTimestampMs/1000/1000000"/>  <!-- mega s -->
          <action type="assignment" variable="strobedDigitalWord" value="(tTrialStartMWTimestampMs- (tTrialStartMWTimestampMs/1000000000)*1000000000) /1000000"/> <!-- mega to kilo s -->
          <action type="assignment" variable="strobedDigitalWord" value="(tTrialStartMWTimestampMs- (tTrialStartMWTimestampMs/1000000)*1000000) /1000"/> <!-- 0-999s -->
          <action type="assignment" variable="strobedDigitalWord" value="(tTrialStartMWTimestampMs - (tTrialStartMWTimestampMs/1000)*1000)"/>  <!-- ms -->
          <action type="assignment" tag="Encode TimestampEnd" variable="strobedDigitalWord" value="201"/>

          <action type="assignment" tag="Sync Matlab" variable="sync" value="1"></action>
          <action type="assignment" tag="Set trialStart" variable="trialStart" value="1"></action>
          <action type="assignment" tag="juice = 0" variable="juice" value="0"></action>
          <action type="assignment" tag="-" variable="laserTriggerFIO" value="0"></action>
          
          <action type="assignment" tag="-" variable="experimentXmlTrialId" value="90"></action>
          
          <!-- choose correct stimulus number based on odds; block2 tr number does not get assigned if ! doBlock2 -->
          <action type="assignment" variable="tStimulusNumber" value="rrStimulusNumber"></action>  <!-- choose a value from selection var, 0-origin -->

          <action type="assignment" variable="tTempStim" value= "tStimulusNumber % (gratingElevationStepN * gratingAzimuthStepN)"/>
          <action type="if" condition="tTempStim = 0">
              <action type="assignment" variable="tTempStim" value= "gratingElevationStepN * gratingAzimuthStepN"/>
          </action>
          <action type="if" condition="tTempStim &lt;= gratingAzimuthStepN">
              <action type="assignment" variable="tGratingAzimuthDeg" value= "gratingAzimuthDeg + (gratingAzimuthStepDeg * (tTempStim-1))"/>
              <action type="assignment" variable="tGratingElevationDeg" value= "gratingElevationDeg"/>
              <action type="report" message="Azimuth is $tGratingAzimuthDeg ; Elevation is $tGratingElevationDeg"/>
          </action>
          <action type="if" condition="tTempStim > gratingAzimuthStepN">
              <action type="assignment" variable="tGratingAzimuthDeg" value= "gratingAzimuthDeg+ (gratingAzimuthStepDeg * ((tTempStim-1) % gratingAzimuthStepN))"/>
              <action type="assignment" variable="tGratingElevationDeg" value= "gratingElevationDeg+ (gratingElevationStepDeg * (ceil(tTempStim / gratingAzimuthStepN)-1))"/>
              <action type="report" message="Azimuth is $tGratingAzimuthDeg ; Elevation is $tGratingElevationDeg"/>
          </action>
          

          
          <!-- assign trial values -->
          <action type="assignment" variable="tGratingContrast" value="gratingContrast"></action>
          <action type="assignment" variable="tGratingDirectionDeg" value="gratingDirectionDeg"></action>
          <action type="assignment" variable="tGratingHeightDeg" value="gratingHeightDeg"></action>
          <action type="assignment" variable="tGratingWidthDeg" value="gratingWidthDeg"></action>                         
          <action type="assignment" variable="tGratingSpatialFreqCPD" value="gratingSpatialFreqCPD"></action>                             
          <action type="assignment" variable="tGratingSpeedDPS" value="gratingSpeedDPS"></action>
          <action type="assignment" variable="tGratingDurationMs" value="gratingDurationMs"></action>
          

          <!-- initialize trial start/end times -->
          <action type="if" condition="tThisTrialStartTimeMs == -1">  
              <!--first trial, leave lasttime as -1 -->
              <action type="assignment" variable="tLastTrialStartTimeMs" value="-1"></action>
          </action>
          <action type="if" condition="tThisTrialStartTimeMs != -1">  <!--else-->
              <!--later trials, copy this into last before setting this again below -->
              <action type="assignment" variable="tLastTrialStartTimeMs" value="tThisTrialStartTimeMs"></action>
          </action>
          <action type="assignment" variable="tThisTrialStartTimeMs" value="now()/1000"></action>

          
              
              
              
              
              
          <!-- compute ITI time -->
          <!-- initialize with a const value.  Do we want this or just to start with counter?-->
          
              
          <!--<action type="assignment" variable="tItiWaitTimeMs" value="1000*(gratingFramesOff / frameRateHz)"></action> -->
           
          <!-- insert counter here -->
          <action type="assignment" tag="Set tCounterOff" variable="tCounterOff" value="counter"></action>
          <action type="assignment" tag="Clear stimulusOn" variable="stimulusOn" value="0"></action>
          <action type="assignment" tag="Encode InterStimIntervalStart" variable="strobedDigitalWord" value="6"></action> 
           -->

          <action type="report" message="In InterStimInterval, waiting for $gratingFramesOff frames"></action>
          
          <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
          <transition type="conditional" tag="If nScansOff, move to StimOn" condition="(counter - tCounterOff) >= nScansOff" target="StimOn"></transition>
      </task_system_state>

      <task_system_state tag="StimOn" interruptible="YES">
            <action_marker _unmoveable="1" tag="Actions"></action_marker>
            <action tag="Queue Stimulus" type="queue_stimulus" stimulus="target_grating"></action>
            <action type="play_dynamic_stimulus" stimulus="target_grating" tag="start"></action>
            <action type="assignment" tag="Encode VisStimOn" variable="strobedDigitalWord" value="4"></action>
            <action type="assignment" tag="Set tCounter to current Counter Value" variable="tCounterOn" value="counter"></action>
          
          <!-- update display, finalize variables -->
            <action tag="Update Display" type="update_stimulus_display"></action>
          
            <action type="report" message="Stim ON, presenting $gratingFramesON frames"></action>
          
          
          <!-- Future Home of TTL Counter -->
            <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
            <transition type="conditional" tag="When nScansOn is equaled or exceeded, end trial" condition="(counter - tCounterOn) >= nScansOn" target="EndTrial" ></transition>
      </task_system_state>
                    
      <task_system_state tag="EndTrial" interruptible="YES">
            <action_marker _unmoveable="1" tag="Actions"></action_marker>

            <action type="assignment" variable="laserTriggerFIO" value="0"></action> <!-- disable trigger no matter if it went high or not -->

            <action tag="Stop IO Device" type="stop_device_IO" device="LabJackU6"></action>
            <action tag="Dequeue Stimulus 0" type="dequeue_stimulus" stimulus="target_grating"></action>
            <action tag="Update Stimulus" type="update_stimulus_display"></action>
            <action type="assignment" tag="End Matlab Sync" variable="sync" value="0"></action>
            

            <action type="assignment" tag="Encode END" variable="strobedDigitalWord" value="85"></action>
            <action type="assignment" tag="Encode END" variable="strobedDigitalWord" value="85"></action>
            <action type="assignment" tag="Encode END" variable="strobedDigitalWord" value="85"></action>

            <!-- trigger serial param dump to cyberkinetics -->
            <action type="assignment" tag="Send serial params" variable="sendSerialParams" value="1"></action>
            <action type="assignment" tag="Send serial params" variable="sendSerialParams" value="0"></action>
            
            <action type="assignment" variable="tTrialsDoneSinceStart" value="tTrialsDoneSinceStart+1"/>
              
            <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
            <transition type="yield" tag="return to parent task system"></transition>
        </task_system_state>

        </task_system>
      </range_replicator>
      </trial>
      </trial>
    </protocol>
  </experiment>
</monkeyml>


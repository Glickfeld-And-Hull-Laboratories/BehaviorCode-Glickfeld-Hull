<?xml version="1.0"?>
<monkeyml version="1.0">
  <io_devices tag="IO Devices">
    <iodevice tag="LabJackU6" priority="" type="LabJackU6" 
      strobed_digital_word="strobedDigitalWord"
      counter="counter"/>
      <iodevice tag="FakeMonkey" priority="" type="fake_monkey" id="" alt="" spike_rate="10"/>
      <iodevice type="serverside_conduit" tag="Server-side Event Conduit" resource_name="server_conduit"/>
    </io_devices>
    <variables tag="Variables">
      <folder tag="Behavioral Control">
        <variable tag="subjectNum" scope="global" logging="when_changed" default_value="0" type="integer" persistant="1" groups="ExptStruct"/>
        <variable tag="experimentXmlTrialId" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/> <!-- n.b. it is forcibly set each trial below -->
      </folder>
      <folder tag="Stimuli">
        <variable tag="stopAfterNTrials" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1" groups="ExptStruct"/>      
        <variable tag="nScansOn" scope="global" logging="when_changed" default_value="200" type="integer" persistant="1" groups="ExptStruct"/>
        <variable tag="nScansOff" scope="global" logging="when_changed" default_value="200" type="integer" persistant="1" groups="ExptStruct"/>
       
        <variable tag="rectangleElevationDeg" scope="global" logging="when_changed" default_value="20" type="float" persistant="1" groups="rectangleSpecs"/>
        <variable tag="rectangleAzimuthDeg" scope="global" logging="when_changed" default_value="-30" type="float" persistant="1" groups="rectangleSpecs"/>
        <variable tag="rectangleSizeDeg" scope="global" logging="when_changed" default_value="-30" type="float" persistant="1" groups="rectangleSpecs"/>

        <variable tag="rectangleContrast" scope="global" logging="when_changed" default_value="0" type="float" persistant="1" groups="rectangleSpecs"/>
        <variable tag="rectangleContrastStep" scope="global" logging="when_changed" default_value=".1" type="float" persistant="1" groups="rectangleSpecs"/>
        <variable tag="rectangleContrastStepN" scope="global" logging="when_changed" default_value="10" type="float" persistant="1" groups="rectangleSpecs"/>

      </folder>
      <folder tag="Task Status">
        <variable tag="stimulusOn" scope="global" logging="when_changed" default_value="0" type="boolean"/>
        <variable tag="trialStart" scope="global" logging="when_changed" default_value="0" type="boolean"/>
      </folder>
      <folder tag="Online Display">
        <variable tag="sync" scope="global" logging="when_changed" default_value="0" type="integer"/>
      </folder>
      <folder tag="Hardware variables">
        <variable tag="juice" full_name="juice" scope="GLOBAL" logging="when_changed" default_value="0" type="integer" groups="Hardware"/>
        <variable tag="counter" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0" groups="Hardware"/>
        <variable tag="sendSerialParams" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
      </folder>
      <folder tag="Internal Variables">
       
        <variable tag="tTrialsDoneSinceStart" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
        <variable tag="tTrialStartMWTimestampMs" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
        <variable tag="tThisTrialStartTimeMs" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
        <variable tag="tLastTrialStartTimeMs" scope="global" logging="when_changed" default_value="90" type="integer" persistant="1"/>
        
        <variable tag="tTempStim" scope="local" logging="when_changed" default_value="0" type="integer" persistant="0"/>
        <variable tag="rrStimulusNumber" scope="local" logging="when_changed" default_value="0" type="integer" persistant="0"/>
        <variable tag="tStimulusNumber" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>

        <variable tag="tRectangleContrast" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
        <variable tag="tempRectangleContrast" scope="global" logging="when_changed" default_value="0" type="float" persistant="0"/>
        
        
        <variable tag="tNStimAccepted" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>

         <variable type="selection" tag="svSeqStimNumber" values="0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89" selection="sequential_ascending" nsamples="90" sampling_method="samples"/>

      </folder>
    </variables>
    <stimuli tag="Stimuli">
      <stimulus type="blank_screen" tag="background" color="tempRectangleContrast,tempRectangleContrast,tempRectangleContrast"></stimulus>                   
    </stimuli>    
      <experiment tag="Experiment" full_name="">
        <protocol tag="JuiceOnHoldProtocol" full_name="" selection="sequential" nsamples="1" sampling_method="cycles" description="" interruptible="YES">
          <action type="assignment" variable="tempRectangleContrast" value= "rectangleContrast"/>
          <action type="queue_stimulus" stimulus="background"></action>

          <action tag="Start IO Device" type="start_device_IO" device="LabJackU6"></action>
          <!-- init actions before running trials after any press of start-->

          <action type="assignment" variable="tTrialsDoneSinceStart" value="0"></action>
          <action type="assignment" tag="set counter to 0" variable="counter" value="0"></action>

          <trial tag="Trial" full_name="Trial" description="" interruptible="1" selection="sequential" nsamples="1" sampling_method="cycles">
            <trial tag="New List" nsamples="9999" sampling_method="samples" selection="random_without_replacement">
              <!--<range_replicator tag="New Replicator" from="0" to="89" step="1" variable="rrStimulusNumber"> -->
              <task_system tag="TS" full_name="TS" description="" interruptible="YES" >
                <task_system_state tag="Inter Stimulus Interval" interruptible="YES">
                  <action_marker _unmoveable="1" tag="Actions"></action_marker>

                  <!-- reset selection var -->
                  <action type="if" condition="tTrialsDoneSinceStart == 0">  
                    <action type="reset_selection" selection="svSeqStimNumber"></action>
                    <action type="assignment" variable="tNStimAccepted" value="0"></action>
                  </action> 

                <action type="update_stimulus_display" tag="-"></action>        
                <!-- if we have done enough trials, abort this trial - before any encodes/sync are done -->
                <action type="if" condition="stopAfterNTrials > 0 &amp;&amp; tTrialsDoneSinceStart > stopAfterNTrials">
                  <action type="report" message="** Stopping after completing $stopAfterNTrials trials"></action>
                  <action type="stop_experiment"></action>  
                </action>


                <action type="assignment" variable="tTrialStartMWTimestampMs" value="now()/1000"></action>  <!-- integer valued ms timestamp -->

                <action type="assignment" tag="Encode START" variable="strobedDigitalWord" value="170"></action>
                <action type="assignment" tag="Encode START" variable="strobedDigitalWord" value="170"></action>
                <action type="assignment" tag="Encode START" variable="strobedDigitalWord" value="170"></action>

                <!--Transmit the trial timestamp so strobed code sequences are unique -->
                <action type="assert" condition="tTrialStartMWTimestampMs &lt;= 2147483648" 
                  message="tTrialStartMWTimestampMs is too large - should happen only after several days of running!?"
                  stop_on_failure="1"/>  
                  <!-- prevent overflow outside 2**31ms ~ 10 days - I don't know how to get unsigned casts in the XML -->
                  <!-- encode trialStartTimestamp in bytes: 4 bytes: millions of seconds, 1000s, s, ms -->
                  <action type="assignment" tag="Encode TimestampStart" variable="strobedDigitalWord" value="200"/>
                  
                  <action type="assignment" tag="Encode TimestampEnd" variable="strobedDigitalWord" value="201"/>

                  <action type="assignment" tag="Sync Matlab" variable="sync" value="1"></action>
                  <action type="assignment" tag="Set trialStart" variable="trialStart" value="1"></action>


                  <!-- choose correct stimulus number based on odds; block2 tr number does not get assigned if ! doBlock2 -->
                  <action type="assignment" variable="tStimulusNumber" value="svSeqStimNumber"/>

                  <!--Select contrast -->
                  
                  <action type="assignment" variable="tTempStim" value= "tStimulusNumber % rectangleContrastStepN"/>
                    <action type="assignment" variable="tRectangleContrast" value= "rectangleContrast + (rectangleContrastStep*tTempStim)"/>
                    <action type="report" message="Contrast is $tRectangleContrast"/>
                  </action>		

                 

              <!-- check for tGratingContrast>1 -->
            <action type="if" condition="tRectangleContrast>1">
                <action type="assignment" variable="tRectangleContrast" value= "1"/>
            </action> 

              
              <!-- initialize trial start/end times -->
              <action type="if" condition="tThisTrialStartTimeMs == -1">  
                <!--first trial, leave lasttime as -1 -->
                <action type="assignment" variable="tLastTrialStartTimeMs" value="-1"></action>
              </action>
              <action type="if" condition="tThisTrialStartTimeMs != -1">  <!--else-->
                <!--later trials, copy this into last before setting this again below -->
                <action type="assignment" variable="tLastTrialStartTimeMs" value="tThisTrialStartTimeMs"></action>
              </action>
              <action type="assignment" variable="tThisTrialStartTimeMs" value="now()/1000"></action>
              <action type="assignment" tag="Clear stimulusOn" variable="stimulusOn" value="0"></action>
              <action type="assignment" tag="Encode InterStimIntervalStart" variable="strobedDigitalWord" value="6"></action> 

              <action type="report" message="In InterStimInterval, waiting for $nScansOff frames"></action>          
              <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
              <transition type="conditional" tag="If nScansOff, move to StimOn" condition="counter >= ((nScansOff+nScansOn) * tTrialsDoneSinceStart) + nScansOff" target="StimOn"></transition>
            </task_system_state>

            <task_system_state tag="StimOn" interruptible="YES">
              <action_marker _unmoveable="1" tag="Actions"></action_marker>

                <action type="assignment" variable="tempRectangleContrast" value= "tRectangleContrast"/>

              <!-- update display, finalize variables -->
              <action tag="Update Display" type="update_stimulus_display"></action>
              
              <action type="report" message="Visual Stim ON, presenting for $nScansOn scans."></action>
              

            <action type="assignment" tag="Encode VisStimOn" variable="strobedDigitalWord" value="4"></action>

                        <!-- Can't actually jave a system state for timer 1, but it would be here-->
            <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
            <transition type="conditional" tag="If nScansON, move to EndTrial" condition="counter >= (nScansOff+nScansOn) * (1+tTrialsDoneSinceStart)" target="EndTrial" ></transition>
          </task_system_state>

          <task_system_state tag="EndTrial" interruptible="YES">
            <action_marker _unmoveable="1" tag="Actions"></action_marker>
            <action type="assignment" variable="tempRectangleContrast" value= "rectangleContrast"/>
              <action tag="Update Stimulus" type="update_stimulus_display"></action>
           
            <!-- Must use next selection and reset selection here to move through rand/seq -->
            <action type="if" condition="doRand == 0 &amp;&amp; tNStimAccepted &lt; 89">
              <action type="next_selection" selection="svSeqStimNumber"/>
              <action type="assignment" variable="tNStimAccepted" value="tNStimAccepted + 1"></action>
            </action>
            <action type="if" condition="doRand == 0 &amp;&amp; tNStimAccepted &gt;= 89">
              <action type="reset_selection" selection="svSeqStimNumber"/>
              <action type="assignment" variable="tNStimAccepted" value="0"></action>
            </action>

            <action type="assignment" tag="End Matlab Sync" variable="sync" value="0"></action>
            

            <action type="assignment" tag="Encode END" variable="strobedDigitalWord" value="85"></action>
            <action type="assignment" tag="Encode END" variable="strobedDigitalWord" value="85"></action>
            <action type="assignment" tag="Encode END" variable="strobedDigitalWord" value="85"></action>

            <!-- trigger serial param dump to cyberkinetics -->
            <action type="assignment" tag="Send serial params" variable="sendSerialParams" value="1"></action>
            <action type="assignment" tag="Send serial params" variable="sendSerialParams" value="0"></action>
            
            <action type="assignment" variable="tTrialsDoneSinceStart" value="tTrialsDoneSinceStart+1"/>

            <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
            <transition type="yield" tag="return to parent task system"></transition>
          </task_system_state>
          
        </task_system>
      </trial>
    </trial>
    <action tag="Stop IO Device" type="stop_device_IO" device="LabJackU6"></action>
  </protocol>
</experiment>
</monkeyml>


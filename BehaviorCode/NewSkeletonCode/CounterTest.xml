<?xml version="1.0"?>
<monkeyml version="1.0">
  <io_devices tag="IO Devices">
    <iodevice tag="LabJackU6" priority="" type="LabJackU6" 
              pulse_duration="juice" pulse_on="juice" 
              lever1="FIO1" lever2=""
              lever1_solenoid="FIO2"
              lever2_solenoid=""
              laser_trigger=""
              strobed_digital_word=""/>
    <iodevice tag="FakeMonkey" priority="" type="fake_monkey" id="" alt="" spike_rate="10"/>
    <iodevice type="serverside_conduit" tag="Server-side Event Conduit" resource_name="server_conduit"/>
  </io_devices>
  <variables tag="Variables">
      <folder tag="Testing Control">
          <variable tag="nTrials" scope="global" logging="when_changed" default_value="10" type="integer" persistant="1"/>
          <variable tag="tTrialNumber" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
          <variable tag="nCounts" scope="global" logging="when_changed" default_value="20" type="integer" persistant="1"/>
          <variable tag="tCounts" scope="global" logging="when_changed" default_value="0" type="integer" persistant="0"/>
          <variable tag="pulsePeriodMs" scope="global" logging="when_changed" default_value="1000" type="integer" persistant="1"/>
          <variable tag="pulseDurationMs" scope="global" logging="when_changed" default_value="100" type="integer" persistant="1"/>
          <variable tag="isTTLHigh" scope="global" logging="when_changed" default_value="0" type="boolean" presistant="0"/>
          
      </folder>
      <folder tag="Hardware variables">
          <variable tag="juice" full_name="juice" scope="GLOBAL" logging="when_changed" default_value="0" type="integer"/>
          <variable tag="FIO1" full_name="FIO1" default_value="0" scope="GLOBAL" type="boolean" editable="never" logging="when_changed"/>
          <variable tag="FIO2" full_name="FIO2" default_value="0" scope="GLOBAL" type="boolean" editable="never" logging="when_changed"/>
      </folder>
  </variables>
  <experiment tag="Experiment" full_name="">
      <protocol tag="JuiceOnHoldProtocol" full_name="" selection="sequential" nsamples="1" sampling_method="cycles" description="" interruptible="YES">
          <trial tag="Trial" full_name="Trial" description="" interruptible="1" selection="sequential" nsamples="1000" sampling_method="cycles">
            <task_system tag="TS" full_name="TS" interruptable="YES" description="" interruptible="YES" _error="">
                <task_system_state tag="Send TTL" interruptible="YES">
                    <action_marker _unmoveable="1" tag="Actions"></action_marker>
                    
                    <action tag="Start IO Device" type="start_device_IO" device="LabJackU6"></action>
                    
                    <action type="if" condition="tTrialNumber == 0">
                        <action type="report" message="***** First Trial *****"/>
                    </action>
                    
                    <action type="if" condition="tTrialNumber > 0 &amp;&amp; tTrialNumber >= nTrials">
                        <action type="report" message="** Stopped after completing $nTrials trials "/>
                        <action type="stop_experiment"/>
                    </action>
                    
                    <action type="schedule" delay="pulseDurationMs*1000" duration="pulsePeriodMs*1000" repeats="nCounts">
                        <action type="assignment" variable="FIO2" value="1"/>
                        <action type="report" message="** Sending Pulse Now **"/>
                    </action>       
                    
                    <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
                    <transition type="direct" tag="Go to waiting for pulses" target="ReceiveTTL" timer=""></transition>
                </task_system_state>
                
                <task_system_state tag="ReceiveTTL" interruptible="YES">
                    <action_marker _unmoveable="1" tag="Actions"></action_marker>
                    <action type="start_timer" tag="Start TTL Timer" timer="receiveTimer" timebase="" duration="100" duration_units="ms"/>
                    
                    <action type="if" condition="FIO1==1 &amp;&amp; isTTLHigh==0" >
                        <action type="assignment" variable="tCounts" value="tCounts+1"/>
                        <action type="assignment" variable="isTTLHigh" value="1"/>
                        <action type="assignment" variable="FIO2" value="0"/>
                        <action type="report" message="*** TTL Received ***"/>
                    </action>
                    
                    <action type="if" condition="FIO1==0" >
                        <action type="assignment" variable="isTTLHigh" value="0"/>
                    </action>
                  <!--  <action type="report" message="Waiting for $nCounts - $tCounts more TTL pulses."/> -->
                    
                    
                    <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
                    <transition type="timer_expired" target="ReceiveTTL" timer="receiveTimer"/>
                    <transition type="conditional" condition="nCounts &lt;= tCounts" target="EndTrial"/>
                </task_system_state>
        
                <task_system_state tag="EndTrial" interruptible="YES">
                    <action_marker _unmoveable="1" tag="Actions"></action_marker>
                    <action type="assignment" tag="" variable="tTrialNumber" value="tTrialNumber+1"/>
                    <action type="assignment" tag="" variable="tCounts" value="0"/>
                    <action tag="Stop IO Device" type="stop_device_IO" device="LabJackU6"></action>
                    <action type="report" message="***** Trial $tTrialNumber Complete: Returning to Start *****"/>
                    
                    <transition_marker _unmoveable="1" tag="Transitions"></transition_marker>
                    <transition type="yield" tag="return to parent task system"></transition>
        </task_system_state>

        </task_system>
      </trial>
    </protocol>
  </experiment>
</monkeyml>

